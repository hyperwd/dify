services:
  # Dify API Service - 使用官方镜像
  api:
    image: langgenius/dify-api:0.9.0
    container_name: dify-api
    restart: unless-stopped
    ports:
      - "SERVER_IP_HERE:5001:5001"
    environment:
      MODE: api
      LOG_LEVEL: INFO
      SECRET_KEY: ${SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U}
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:difyai123@db:5432/dify}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      CODE_EXECUTION_ENDPOINT: ${CODE_EXECUTION_ENDPOINT:-http://sandbox:8194}
      CODE_EXECUTION_API_KEY: ${CODE_EXECUTION_API_KEY:-dify-sandbox}
      CODE_MAX_NUMBER: ${CODE_MAX_NUMBER:-9223372036854775807}
      CODE_MIN_NUMBER: ${CODE_MIN_NUMBER:--9223372036854775808}
      CODE_STRING_MAX_LENGTH: ${CODE_STRING_MAX_LENGTH:-80000}
      CODE_MAX_STRING_ARRAY_LENGTH: ${CODE_MAX_STRING_ARRAY_LENGTH:-1000}
      CODE_MAX_OBJECT_ARRAY_LENGTH: ${CODE_MAX_OBJECT_ARRAY_LENGTH:-1000}
      CODE_MAX_NUMBER_ARRAY_LENGTH: ${CODE_MAX_NUMBER_ARRAY_LENGTH:-1000}
      CODE_MAX_STRING_OBJECT_LENGTH: ${CODE_MAX_STRING_OBJECT_LENGTH:-1000}
      CODE_MAX_NUMBER_OBJECT_LENGTH: ${CODE_MAX_NUMBER_OBJECT_LENGTH:-1000}
      CODE_MAX_DEPTH: ${CODE_MAX_DEPTH:-5}
      CODE_EXECUTION_TIMEOUT: ${CODE_EXECUTION_TIMEOUT:-15}
      CODE_EXECUTION_CONNECTION_TIMEOUT: ${CODE_EXECUTION_CONNECTION_TIMEOUT:-10}
      VECTOR_STORE: ${VECTOR_STORE:-weaviate}
      WEAVIATE_ENDPOINT: ${WEAVIATE_ENDPOINT:-http://weaviate:8080}
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: ${STORAGE_LOCAL_PATH:-storage}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
      WEB_API_CORS_ALLOW_ORIGINS: ${WEB_API_CORS_ALLOW_ORIGINS:-*}
    volumes:
      - ../volumes/app/storage:/app/api/storage
      - ../volumes/app/logs:/app/api/logs
    depends_on:
      - db
      - redis
    networks:
      - dify-network

  # Dify Worker Service - 使用官方镜像
  worker:
    image: langgenius/dify-api:0.9.0
    container_name: dify-worker
    restart: unless-stopped
    environment:
      MODE: worker
      LOG_LEVEL: INFO
      SECRET_KEY: ${SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U}
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:difyai123@db:5432/dify}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      CODE_EXECUTION_ENDPOINT: ${CODE_EXECUTION_ENDPOINT:-http://sandbox:8194}
      CODE_EXECUTION_API_KEY: ${CODE_EXECUTION_API_KEY:-dify-sandbox}
      VECTOR_STORE: ${VECTOR_STORE:-weaviate}
      WEAVIATE_ENDPOINT: ${WEAVIATE_ENDPOINT:-http://weaviate:8080}
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: ${STORAGE_LOCAL_PATH:-storage}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
    volumes:
      - ../volumes/app/storage:/app/api/storage
    depends_on:
      - db
      - redis
    networks:
      - dify-network

  # Dify Web Service - 自定义品牌构建
  web:
    image: dify-web-brand
    container_name: dify-web
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - dify-network
    ports:
      - "3000:3000"

  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: dify-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-dify}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-difyai123}
      PGDATA: ${PGDATA:-/var/lib/postgresql/data/pgdata}
    volumes:
      - ../volumes/db/postgres:/var/lib/postgresql/data
    networks:
      - dify-network

  # Redis Cache - 禁用密码测试
  redis:
    image: redis:7-alpine
    container_name: dify-redis
    restart: unless-stopped
    volumes:
      - ../volumes/redis/data:/data
    networks:
      - dify-network

  # Weaviate Vector Database (简化配置)
  weaviate:
    image: semitechnologies/weaviate:1.19.0
    container_name: dify-weaviate
    restart: unless-stopped
    environment:
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      CLUSTER_HOSTNAME: 'node1'
    volumes:
      - ../volumes/weaviate:/var/lib/weaviate
    networks:
      - dify-network

  # Sandbox for code execution
  sandbox:
    image: langgenius/dify-sandbox:0.2.1
    container_name: dify-sandbox
    restart: unless-stopped
    environment:
      API_KEY: ${CODE_EXECUTION_API_KEY:-dify-sandbox}
      GIN_MODE: 'release'
      WORKER_TIMEOUT: 15
      ENABLE_NETWORK: '1'
    volumes:
      - ../volumes/sandbox:/var/sandbox
    networks:
      - dify-network

networks:
  dify-network:
    driver: bridge