version: '3.8'

services:
  # Dify API Service
  api:
    build:
      context: ../api
      dockerfile: ../almalinux9/Dockerfile.api
    container_name: dify-api
    restart: unless-stopped
    environment:
      MODE: api
      LOG_LEVEL: INFO
      SECRET_KEY: ${SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U}
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:difyai123@db:5432/dify}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      WEB_API_CORS_ALLOW_ORIGINS: ${WEB_API_CORS_ALLOW_ORIGINS:-*}
      CODE_MAX_NUMBER: ${CODE_MAX_NUMBER:-9223372036854775807}
      CODE_MIN_NUMBER: ${CODE_MIN_NUMBER:--9223372036854775808}
      CODE_STRING_MAX_LENGTH: ${CODE_STRING_MAX_LENGTH:-80000}
      TEMPLATE_TRANSFORM_MAX_LENGTH: ${TEMPLATE_TRANSFORM_MAX_LENGTH:-80000}
      CODE_MAX_STRING_ARRAY_LENGTH: ${CODE_MAX_STRING_ARRAY_LENGTH:-1000}
      CODE_MAX_OBJECT_ARRAY_LENGTH: ${CODE_MAX_OBJECT_ARRAY_LENGTH:-1000}
      CODE_MAX_NUMBER_ARRAY_LENGTH: ${CODE_MAX_NUMBER_ARRAY_LENGTH:-1000}
      CODE_MAX_STRING_OBJECT_LENGTH: ${CODE_MAX_STRING_OBJECT_LENGTH:-1000}
      CODE_MAX_NUMBER_OBJECT_LENGTH: ${CODE_MAX_NUMBER_OBJECT_LENGTH:-1000}
      CODE_MAX_DEPTH: ${CODE_MAX_DEPTH:-5}
      CODE_EXECUTION_TIMEOUT: ${CODE_EXECUTION_TIMEOUT:-15}
      CODE_EXECUTION_CONNECTION_TIMEOUT: ${CODE_EXECUTION_CONNECTION_TIMEOUT:-10}
      CODE_EXECUTION_ENDPOINT: ${CODE_EXECUTION_ENDPOINT:-http://sandbox:8194}
      CODE_EXECUTION_API_KEY: ${CODE_EXECUTION_API_KEY:-dify-sandbox}
      CODE_SANDBOX_API_KEY: ${CODE_SANDBOX_API_KEY:-dify-sandbox}
      # Vector database configuration
      VECTOR_STORE: ${VECTOR_STORE:-weaviate}
      WEAVIATE_ENDPOINT: ${WEAVIATE_ENDPOINT:-http://weaviate:8080}
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY:-}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-}
      MILVUS_HOST: ${MILVUS_HOST:-milvus}
      MILVUS_PORT: ${MILVUS_PORT:-19530}
      MILVUS_USER: ${MILVUS_USER:-root}
      MILVUS_PASSWORD: ${MILVUS_PASSWORD:-Milvus}
      # Storage configuration
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: ${STORAGE_LOCAL_PATH:-storage}
      # S3 configuration (if needed)
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_BUCKET_NAME: ${S3_BUCKET_NAME:-}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      # Azure Blob configuration (if needed)
      AZURE_BLOB_ACCOUNT_NAME: ${AZURE_BLOB_ACCOUNT_NAME:-}
      AZURE_BLOB_ACCOUNT_KEY: ${AZURE_BLOB_ACCOUNT_KEY:-}
      AZURE_BLOB_CONTAINER_NAME: ${AZURE_BLOB_CONTAINER_NAME:-}
      # Aliyun OSS configuration (if needed)
      ALIYUN_OSS_REGION: ${ALIYUN_OSS_REGION:-}
      ALIYUN_OSS_BUCKET_NAME: ${ALIYUN_OSS_BUCKET_NAME:-}
      ALIYUN_OSS_ACCESS_KEY_ID: ${ALIYUN_OSS_ACCESS_KEY_ID:-}
      ALIYUN_OSS_ACCESS_KEY_SECRET: ${ALIYUN_OSS_ACCESS_KEY_SECRET:-}
      # Tencentyun COS configuration (if needed)
      TENCENT_COS_REGION: ${TENCENT_COS_REGION:-}
      TENCENT_COS_BUCKET_NAME: ${TENCENT_COS_BUCKET_NAME:-}
      TENCENT_COS_SECRET_ID: ${TENCENT_COS_SECRET_ID:-}
      TENCENT_COS_SECRET_KEY: ${TENCENT_COS_SECRET_KEY:-}
      # Model configuration
      MODEL_PROVIDER: ${MODEL_PROVIDER:-openai}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      # Multi-model configuration
      AZURE_OPENAI_API_BASE: ${AZURE_OPENAI_API_BASE:-}
      AZURE_OPENAI_API_KEY: ${AZURE_OPENAI_API_KEY:-}
      AZURE_OPENAI_LLM_BASE: ${AZURE_OPENAI_LLM_BASE:-}
      AZURE_OPENAI_LLM_KEY: ${AZURE_OPENAI_LLM_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      XINFERENCE_SERVER_URL: ${XINFERENCE_SERVER_URL:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      # Encryption configuration
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
    volumes:
      - ../volumes/app/storage:/app/api/storage
      - ../volumes/app/logs:/app/api/logs
    depends_on:
      - db
      - redis
    networks:
      - dify-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Dify Worker Service
  worker:
    build:
      context: ../api
      dockerfile: ../almalinux9/Dockerfile.api
    container_name: dify-worker
    restart: unless-stopped
    environment:
      MODE: worker
      LOG_LEVEL: INFO
      SECRET_KEY: ${SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U}
      DATABASE_URL: ${DATABASE_URL:-postgresql://postgres:difyai123@db:5432/dify}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/1}
      # Code execution configuration
      CODE_EXECUTION_ENDPOINT: ${CODE_EXECUTION_ENDPOINT:-http://sandbox:8194}
      CODE_EXECUTION_API_KEY: ${CODE_EXECUTION_API_KEY:-dify-sandbox}
      CODE_SANDBOX_API_KEY: ${CODE_SANDBOX_API_KEY:-dify-sandbox}
      CODE_MAX_NUMBER: ${CODE_MAX_NUMBER:-9223372036854775807}
      CODE_MIN_NUMBER: ${CODE_MIN_NUMBER:--9223372036854775808}
      CODE_STRING_MAX_LENGTH: ${CODE_STRING_MAX_LENGTH:-80000}
      CODE_EXECUTION_TIMEOUT: ${CODE_EXECUTION_TIMEOUT:-15}
      CODE_EXECUTION_CONNECTION_TIMEOUT: ${CODE_EXECUTION_CONNECTION_TIMEOUT:-10}
      # Vector database configuration
      VECTOR_STORE: ${VECTOR_STORE:-weaviate}
      WEAVIATE_ENDPOINT: ${WEAVIATE_ENDPOINT:-http://weaviate:8080}
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY:-}
      # Storage configuration
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: ${STORAGE_LOCAL_PATH:-storage}
      # Model configuration
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
    volumes:
      - ../volumes/app/storage:/app/api/storage
    depends_on:
      - db
      - redis
    networks:
      - dify-network

  # Dify Web Service
  web:
    build:
      context: ../web
      dockerfile: ../almalinux9/Dockerfile.web
    container_name: dify-web
    restart: unless-stopped
    environment:
      CONSOLE_API_URL: ${CONSOLE_API_URL:-}
      CONSOLE_WEB_URL: ${CONSOLE_WEB_URL:-}
      APP_API_URL: ${APP_API_URL:-}
      APP_WEB_URL: ${APP_WEB_URL:-}
    depends_on:
      - api
    networks:
      - dify-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: dify-nginx
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/proxy.conf:/etc/nginx/proxy.conf:ro
      - ../volumes/web/nginx/logs:/var/log/nginx
    depends_on:
      - api
      - web
    networks:
      - dify-network
    ports:
      - "80:80"
      - "443:443"

  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: dify-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-dify}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-difyai123}
      PGDATA: ${PGDATA:-/var/lib/postgresql/data/pgdata}
    volumes:
      - ../volumes/db/postgres:/var/lib/postgresql/data
    networks:
      - dify-network
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: dify-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-difyai123}
    volumes:
      - ../volumes/redis/data:/data
    networks:
      - dify-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Weaviate Vector Database (default)
  weaviate:
    image: semitechnologies/weaviate:1.19.0
    container_name: dify-weaviate
    restart: unless-stopped
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'false'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'none'
      ENABLE_MODULES: 'text2vec-openai,generative-openai'
      CLUSTER_HOSTNAME: 'node1'
      AUTHENTICATION_APIKEY_ENABLED: 'true'
      AUTHENTICATION_APIKEY_ALLOWED_KEYS: ${WEAVIATE_API_KEY:-WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih}
      OPENAI_APIKEY: ${OPENAI_API_KEY:-}
    volumes:
      - ../volumes/weaviate:/var/lib/weaviate
    networks:
      - dify-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/.well-known/ready"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Sandbox for code execution
  sandbox:
    image: langgenius/dify-sandbox:0.2.1
    container_name: dify-sandbox
    restart: unless-stopped
    environment:
      API_KEY: ${CODE_EXECUTION_API_KEY:-dify-sandbox}
      GIN_MODE: 'release'
      WORKER_TIMEOUT: 15
      ENABLE_NETWORK: '1'
      HTTP_PROXY: ${HTTP_PROXY:-}
      HTTPS_PROXY: ${HTTPS_PROXY:-}
    volumes:
      - ../volumes/sandbox:/var/sandbox
    networks:
      - dify-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8194/health"]
      interval: 30s
      timeout: 10s
      retries: 5

networks:
  dify-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16